#Informar sua instancia de SQL Server
$SQLServer = "DESKTOP-A7S2JPV\SQLSERVER2014"

#Dbatools, capturando a build da sua instancia SQL Server
Connect-DbaInstance -SqlInstance $SQLServer | Select ProductLevel, ResourceVersion -OutVariable Version

$VersionBuild = [string]$Version[0].ResourceVersion

$ProductLevel = [string]$Version[0].ProductLevel

#Buscando mais informações sobre a build o seu ambiente
#https://github.com/Jamal27/SQLServer_Scripts/blob/master/Get-SQLBuildVersion
Get-SQLBuildVersion $VersionBuild -OutVariable TableVersion

$ResultTestHtml = ""

$count = 0

#Prepara HTML para enviar e-mail
ForEach($obj in $TableVersion)
{   
    if($count.Equals(0))##Add a Header
    {   
        $ResultTestHtml +=  ConvertTo-Html -InputObject $obj -As List -Head '<h1 style="color:blue;">SQL SERVER VERSION:</h1><H3>UPDATED VERSION TABLE <H5><a href="https://buildnumbers.wordpress.com/sqlserver/">buildnumbers.wordpress.com</a></H5></H3>' 
    }
    else
    {     
        $ResultTestHtml +=  ConvertTo-Html -InputObject $obj -As List 
    }    
    $count +=1
}

$ResultTestHtml +=  '<br></br><H3>YOUR SQL SERVER VERSION</H3>'
$ResultTestHtml +=  ConvertTo-Html -InputObject $Version[0] -As List 

#Valida se a versão do seu ambiente está atualizada e adiciona mensagem no rodapé do e-mail
if($TableVersion.Latest.Substring(0,8) -ne $VersionBuild.Substring(0,8))
{
    $ResultTestHtml +=  '<H2 style="color:red;">HOUSTON WE HAVE A PROBLEM WITH YOUR SQL SERVER VERSION...</H2>'
}
else
{
    $ResultTestHtml +=  '<H2 style="color:blue;">KEEP CALM AND DRINK BEER! WE ARE UPDATED!!</H2>'
}

#Importa credencial
$cred = Import-Clixml C:\Temp\cred.xml 

#Define assunto do e-mail
$Subject = "Check SQL Server Version - " + $SQLServer

#Envia o e-mail
Send-MailMessage -Credential $cred -SmtpServer "smtp.office365.com" -To "reginaldo.silva@dataside.com.br" -From "reginaldo.silva@dataside.com.br" -Subject $Subject -UseSsl -Body $ResultTestHtml -BodyAsHtml -Priority High
